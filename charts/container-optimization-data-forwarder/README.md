# Densify Container Optimization Helm Chart

<img src="https://www.densify.com/wp-content/uploads/densify.png" width="300">

## Introduction

This chart deploys the [Densify Container Optimization Data Forwarder](https://github.com/densify-dev/container-data-collection), which collects data from a Prometheus server or observability platform and forwards it to a Densify instance for analysis.

## Details

* Deploys configmap, job, and cronjob.
* Cronjob is scheduled to run hourly to collect data from Prometheus and forward it to Densify for analysis.

## Prerequisites

See [here](https://github.com/densify-dev/container-data-collection/blob/main/requirements.md).

## Installing

To deploy Data Forwarder with Helm, follow these steps below:

```console
helm repo add densify https://densify-dev.github.io/helm-charts
```

You can then run `helm search repo container-optimization-data-forwarder` to see the chart.

## Configuration

The following table lists configuration parameters in values.yaml and their default values.

| Parameter                                                | Mandatory/Context                     | Description                                                                                                                                                                                                                                                                                                                                                                                                                                     | Default                                                                                                                                                                                                         |
| -------------------------------------------------------- | ------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `nameOverride`                                           |                                       | Helm chart name override                                                                                                                                                                                                                                                                                                                                                                                                                        | `densify-forwarder`                                                                                                                                                                                             |
| `image`                                                  |                                       | Image to use for the Densify Container Optimization Data Forwarder                                                                                                                                                                                                                                                                                                                                                                              | `densify/container-optimization-data-forwarder:4`                                                                                                                                                               |
| `imageAzureToken`                                        | `Azure Monitor Managed Prometheus`    | Image to use for the init container to get Azure REST API token                                                                                                                                                                                                                                                                                                                                                                                 | `densify/azure-rest-api-token:latest`                                                                                                                                                                           |
| `pullPolicy`                                             |                                       | Image pull policy for containers                                                                                                                                                                                                                                                                                                                                                                                                                | `Always`                                                                                                                                                                                                        |
| `config.forwarder.`<br/>`densify.url.scheme`             |                                       | Densify connection scheme (`http/https`)                                                                                                                                                                                                                                                                                                                                                                                                        | `https`                                                                                                                                                                                                         |
| `config.forwarder.`<br/>`densify.url.host`               | :white_check_mark:                    | Densify instance hostname (`<instance>.densify.com`)                                                                                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                 |
| `config.forwarder.`<br/>`densify.url.port`               |                                       | Densify connection port                                                                                                                                                                                                                                                                                                                                                                                                                         | `443`                                                                                                                                                                                                           |
| `config.forwarder.`<br/>`densify.url.username`           |                                       | Densify user account. You must specify either a `password` or an `encrypted_password` along with this parameter. This user must already exist in your Densify instance and have API access privileges. Alternatively, you can use `UserSecretName` for authentication instead of `user/(encrypted_)password` combination (see `UserSecretName` below)                                                                                           |                                                                                                                                                                                                                 |
| `config.forwarder.`<br/>`densify.url.password`           |                                       | Password for the Densify user. Only specify a `password` or an `encrypted_password` (not both)                                                                                                                                                                                                                                                                                                                                                  |                                                                                                                                                                                                                 |
| `config.forwarder.`<br/>`densify.url.encrypted_password` |                                       | Encrypted password for the Densify User. If you specify an `encrypted_password`, then disable the `password` parameter                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                 |
| `config.forwarder.`<br/>`densify.url.UserSecretName`     |                                       | Secret name used to store the Densify user and encrypted password (must contain keys `username` and `epassword`). If this parameter is used, then `username, password, encrypted_password` parameters must all be disabled                                                                                                                                                                                                                      |                                                                                                                                                                                                                 |
| `config.forwarder.`<br/>`densify.endpoint`               |                                       | Densify API endpoint                                                                                                                                                                                                                                                                                                                                                                                                                            | `/api/v2/`                                                                                                                                                                                                      |
| `config.forwarder.`<br/>`densify.retry.wait_min`         |                                       | Densify connection retry minimum wait (seconds)                                                                                                                                                                                                                                                                                                                                                                                                 | `1`                                                                                                                                                                                                             |
| `config.forwarder.`<br/>`densify.retry.wait_max`         |                                       | Densify connection retry maximum wait (seconds)                                                                                                                                                                                                                                                                                                                                                                                                 | `30`                                                                                                                                                                                                            |
| `config.forwarder.`<br/>`densify.retry.max_attempts`     |                                       | Densify connection retry maximum attempts                                                                                                                                                                                                                                                                                                                                                                                                       | `4`                                                                                                                                                                                                             |
| `config.forwarder.`<br/>`densify.retry.policy`           |                                       | Densify connection retry policy: `default` (same as `exponential`), `exponential` or `jitter`)                                                                                                                                                                                                                                                                                                                                                  | `default`                                                                                                                                                                                                       |
| `config.forwarder.`<br/>`proxy.url.scheme`               |                                       | Proxy connection scheme (`http/https`)                                                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                 |
| `config.forwarder.`<br/>`proxy.url.host`                 |                                       | Proxy hostname                                                                                                                                                                                                                                                                                                                                                                                                                                  |                                                                                                                                                                                                                 |
| `config.forwarder.`<br/>`proxy.url.port`                 |                                       | Proxy connection port                                                                                                                                                                                                                                                                                                                                                                                                                           | `443`                                                                                                                                                                                                           |
| `config.forwarder.`<br/>`proxy.url.username`             |                                       | Proxy user name. You must specify either a `password` or an `encrypted_password` along with this parameter. This user must already exist in your proxy. Alternatively, you can use `ProxySecretName` for authentication instead of `user/(encrypted_)password` combination (see `ProxySecretName` below)                                                                                                                                        |                                                                                                                                                                                                                 |
| `config.forwarder.`<br/>`proxy.url.password`             |                                       | Password for the proxy user. Only specify a `password` or an `encrypted_password` (not both)                                                                                                                                                                                                                                                                                                                                                    |                                                                                                                                                                                                                 |
| `config.forwarder.`<br/>`proxy.url.encrypted_password`   |                                       | Encrypted password for the proxy User. If you specify an `encrypted_password`, then disable the `password` parameter                                                                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                 |
| `config.forwarder.`<br/>`proxy.url.ProxySecretName`      |                                       | Secret name used to store the proxy user and password (must contain keys `username` and `password`). If this parameter is used, then `username, password, encrypted_password` parameters must all be disabled                                                                                                                                                                                                                                   |                                                                                                                                                                                                                 |
| `config.forwarder.`<br/>`proxy.auth`                     |                                       | Proxy authentication type: Basic or NTLM                                                                                                                                                                                                                                                                                                                                                                                                        | `Basic`                                                                                                                                                                                                         |
| `config.forwarder.`<br/>`proxy.server`                   | Required for `NTLM` auth              | Proxy server                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                                                                                                                                 |
| `config.forwarder.`<br/>`proxy.domain`                   | Required for `NTLM` auth              | Proxy domain                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                                                                                                                                 |
| `config.forwarder.prefix`                                |                                       | Zip file prefix                                                                                                                                                                                                                                                                                                                                                                                                                                 |                                                                                                                                                                                                                 |
| `config.prometheus.`<br/>`url.scheme`                    |                                       | Prometheus connection scheme (`http/https`)                                                                                                                                                                                                                                                                                                                                                                                                     | `http`                                                                                                                                                                                                          |
| `config.prometheus.`<br/>`url.host`                      | :white_check_mark:                    | Prometheus hostname                                                                                                                                                                                                                                                                                                                                                                                                                             |                                                                                                                                                                                                                 |
| `config.prometheus.`<br/>`url.port`                      |                                       | Prometheus connection port                                                                                                                                                                                                                                                                                                                                                                                                                      | `9090`                                                                                                                                                                                                          |
| `config.prometheus.`<br/>`url.username`                  | Prometheus/platform with `Basic Auth` | Prometheus user account, or a path of a file containing it. You must specify a `password` along with this parameter. This user must already exist in your Prometheus / observability platform and have Prometheus API query access privileges. Alternatively, you can use `PrometheusSecretName` for authentication instead of `user/password` combination (see `PrometheusSecretName` below)                                                   |                                                                                                                                                                                                                 |
| `config.prometheus.`<br/>`url.password`                  | Prometheus/platform with `Basic Auth` | Password for the Prometheus user, or a path of a file containing it                                                                                                                                                                                                                                                                                                                                                                             |                                                                                                                                                                                                                 |
| `config.prometheus.`<br/>`url.PrometheusSecretName`      | Prometheus/platform with `Basic Auth` | Secret name used to store the Prometheus user and password (must contain keys `username` and `password`). If this parameter is used, then `username, password` parameters must all be disabled                                                                                                                                                                                                                                                  |                                                                                                                                                                                                                 |
| `config.prometheus.`<br/>`bearer_token`                  | Prometheus with `Bearer Auth`         | A path of a file containing a bearer token. Use this only if the token is guaranteed to be provided (e.g. `OpenShift monitoring stack` and the Forwarder running under a `service account`). For `Azure Monitor Managed Prometheus`, use `AzureMonitorSecretName` below instead                                                                                                                                                                 |                                                                                                                                                                                                                 |
| `config.prometheus.`<br/>`AzureMonitorSecretName`        | `Azure Monitor Managed Prometheus`    | Secret name used to store the Microsoft Entra Service Principal credentials (must contain key `app.json`, see also [here](https://github.com/densify-dev/container-data-collection/tree/main/multi-cluster/examples/azmp))                                                                                                                                                                                                                      |                                                                                                                                                                                                                 |
| `config.prometheus.`<br/>`ca_cert`                       |                                       | Path to a CA certificate used to communicate with a secured Prometheus server                                                                                                                                                                                                                                                                                                                                                                   |                                                                                                                                                                                                                 |
| `config.prometheus.`<br/>`CaCertSecretName`              |                                       | Secret name used to store the CA Certificate (must contain key `ca.crt`, which is the CA certificate used to communicate with a secured Prometheus server)                                                                                                                                                                                                                                                                                                                                                                   |                                                                                                                                                                                                                 |
| `config.prometheus.`<br/>`sigv4.region`                  | `AWS Managed Prometheus`              | The AWS region of the AMP workspace, mandatory for AMP                                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                 |
| `config.prometheus.`<br/>`sigv4.AwsSecretName`           | `AWS Managed Prometheus`              | If the Forwarder is not running on EKS, secret name used to store AWS credentials (must contain keys `config` and `credentials`). If this parameter is used, then `access_key, secret_key, profile, role_arn` parameters must all be disabled                                                                                                                                                                                                   |                                                                                                                                                                                                                 |
| `config.prometheus.`<br/>`sigv4.access_key`              | `AWS Managed Prometheus`              | AWS access key                                                                                                                                                                                                                                                                                                                                                                                                                                  |                                                                                                                                                                                                                 |
| `config.prometheus.`<br/>`sigv4.secret_key`              | `AWS Managed Prometheus`              | AWS secret key                                                                                                                                                                                                                                                                                                                                                                                                                                  |                                                                                                                                                                                                                 |
| `config.prometheus.`<br/>`sigv4.profile`                 | `AWS Managed Prometheus`              | AWS profile                                                                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                                                                                 |
| `config.prometheus.`<br/>`sigv4.role_arn`                | `AWS Managed Prometheus`              | AWS role ARN                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                                                                                                                                                                                                 |
| `config.prometheus.`<br/>`retry.wait_min`                |                                       | Prometheus connection retry minimum wait (seconds)                                                                                                                                                                                                                                                                                                                                                                                              | `1`                                                                                                                                                                                                             |
| `config.prometheus.`<br/>`retry.wait_max`                |                                       | Prometheus connection retry maximum wait (seconds)                                                                                                                                                                                                                                                                                                                                                                                              | `30`                                                                                                                                                                                                            |
| `config.prometheus.`<br/>`retry.max_attempts`            |                                       | Prometheus connection retry maximum attempts                                                                                                                                                                                                                                                                                                                                                                                                    | `4`                                                                                                                                                                                                             |
| `config.prometheus.`<br/>`retry.policy`                  |                                       | Prometheus connection retry policy: `default` (same as `exponential`), `exponential` or `jitter`)                                                                                                                                                                                                                                                                                                                                               | `default`                                                                                                                                                                                                       |
| `config.collection.`<br/>`include.cluster`               |                                       | Cluster data collection flag                                                                                                                                                                                                                                                                                                                                                                                                                    | `true`                                                                                                                                                                                                          |
| `config.collection.`<br/>`include.container`             |                                       | Container data collection flag                                                                                                                                                                                                                                                                                                                                                                                                                  | `true`                                                                                                                                                                                                          |
| `config.collection.`<br/>`include.node`                  |                                       | Node data collection flag                                                                                                                                                                                                                                                                                                                                                                                                                       | `true`                                                                                                                                                                                                          |
| `config.collection.`<br/>`include.nodegroup`             |                                       | Node Group data collection flag                                                                                                                                                                                                                                                                                                                                                                                                                 | `true`                                                                                                                                                                                                          |
| `config.collection.`<br/>`include.quota`                 |                                       | Resource Quota (all clusters) and Cluster Resource Quota (OpenShift only) data collection flag                                                                                                                                                                                                                                                                                                                                                  | `true`                                                                                                                                                                                                          |
| `config.collection.`<br/>`interval`                      |                                       | Interval to collect data from Prometheus: `days`, `hours` or `minutes`                                                                                                                                                                                                                                                                                                                                                                          | `hours`                                                                                                                                                                                                         |
| `config.collection.`<br/>`interval_size`                 |                                       | The size of the interval to collect data from Prometheus                                                                                                                                                                                                                                                                                                                                                                                        | `1`                                                                                                                                                                                                             |
| `config.collection.`<br/>`history`                       |                                       | The number of `interval_size` blocks of data to collect for historical purposes                                                                                                                                                                                                                                                                                                                                                                 | `1`                                                                                                                                                                                                             |
| `config.collection.`<br/>`offset`                        |                                       | Amount of units (based on `interval` value) to offset the data collection backwards in time                                                                                                                                                                                                                                                                                                                                                     | `0`                                                                                                                                                                                                             |
| `config.collection.`<br/>`sample_rate`                   |                                       | The sample rate for data points to be collected (in `minutes`)                                                                                                                                                                                                                                                                                                                                                                                  | `5`                                                                                                                                                                                                             |
| `config.collection.`<br/>`node_group_list`               |                                       | Comma-separated list of label names to check nodes for and group by if they exist                                                                                                                                                                                                                                                                                                                                                               | `label_cloud_google_com_gke_nodepool,`<br/>`label_eks_amazonaws_com_nodegroup,`<br/>`label_agentpool,`<br/>`label_pool_name,`<br/>`label_alpha_eksctl_io_nodegroup_name,`<br/>`label_kops_k8s_io_instancegroup` |
| `config.clusters`                                        | :white_check_mark:                    | List of Kubernetes clusters. Each cluster should have a unique `name`. If there is more than one cluster, each cluster should also have `identifiers` - a map of Prometheus labels (name and value) to uniquely identify the cluster. The `identifiers` of different clusters must not overlap                                                                                                                                                  |                                                                                                                                                                                                                 |
| `config.debug`                                           |                                       | Indicates if debug logging is enabled                                                                                                                                                                                                                                                                                                                                                                                                           | `false`                                                                                                                                                                                                         |
| `cronJob.schedule`                                       | :white_check_mark:                    | The cronjob schedule. By default, data collection is triggered a few minutes after the top of every hour. This is in line with the default interval settings of collecting the last hour of data.                                                                                                                                                                                                                                               | `5 * * * *`                                                                                                                                                                                                     |
| `rbac.create`                                            |                                       | Indicates if RBAC resources are created and used. This flag must be `true` for API access to OpenShift monitoring stack Prometheus                                                                                                                                                                                                                                                                                                              | `true`                                                                                                                                                                                                          |
| `serviceAccount.create`                                  |                                       | Indicates whether to create a Service Account with the name specified by the `serviceAccount.name` parameter (see below)                                                                                                                                                                                                                                                                                                                        | `true`                                                                                                                                                                                                          |
| `serviceAccount.name`                                    |                                       | The name of the Service Account. If this parameter is disabled, then the Helm chart name is used as the Service Account name (unless `config.prometheus.sigv4.region` is enabled but not `config.prometheus.sigv4.AwsSecretName` or `config.prometheus.sigv4.access key` - in that case the assumed `amp-iamproxy-query-service-account` is used). You can specify an existing Service Account name to use, if serviceAccount.create is `false` |                                                                                                                                                                                                                 |
| `serviceAccount.annotations`                             |                                       | Service Account annotations to use if serviceAccount.create is `true`. The default value are the annotations required by OpenShift                                                                                                                                                                                                                                                                                                              | `[{serviceaccounts.openshift.io/oauth-want-challenges: "true"}]`                                                                                                                                                |
| `nodeSelector`                                           |                                       | The node selector labels for pod assignments                                                                                                                                                                                                                                                                                                                                                                                                    | `{}`                                                                                                                                                                                                            |
| `resources`                                              |                                       | The CPU/Memory resource requests/limits                                                                                                                                                                                                                                                                                                                                                                                                         | `{}`                                                                                                                                                                                                            |
| `tolerations`                                            |                                       | The toleration labels for pod assignments                                                                                                                                                                                                                                                                                                                                                                                                       | `{}`                                                                                                                                                                                                            |

## Limitations

* Supported Architecture: AMD64
* Supported OS: Linux

## Documentation

* [Densify Solutions > Container Platforms](https://www.densify.com/solutions/container-optimization)
* [Densify Feature Description and Reference Guide > Optimizing Your Containers](https://www.densify.com/docs/Content/Densify_Com/Optimizing_Your_Containers.htm)

## License

Apache 2 Licensed. See [LICENSE](LICENSE) for full details.
